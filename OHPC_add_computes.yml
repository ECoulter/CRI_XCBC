
---
 - hosts: headnode
   tasks: 
   - name: fix slurm.conf
     lineinfile:
       dest: /etc/slurm/slurm.conf
       regexp: "{{ item.regex }}"
       line: "{{ item.line }}"
     with_items:
         - { regex: "^NodeName", line: 'NodeName={{ node_glob }}] Sockets=1 CoresPerSocket=1 ThreadsPerCore=1 State=UNKNOWN'}
         - { regex: "^PartitionName", line: 'PartitionName=normal Nodes={{ node_glob }}] Default=YES MaxTime=24:00:00 State=UP' }
#add a line to fix the controller name!!!
 
#   - name: sync files for import
#     command: wwsh file sync

#   - name: test out node glob
#     shell: echo "{{ private_interface }}" {{ node_glob_bash }} >> tmp.txt

#   - name: add nodes with wwnodescan - BOOT NODES NOW IN ORDER
#     shell: wwnodescan --ip=10.1.1.2 --netdev={{ private_interface }} --netmask=255.255.255.0 --bootstrap=`uname -r` --vnfs=centos7.1 {{ node_glob_bash }}

#   - name: add compute nodes to inventory
#     add_host: name={{ node_glob }} group="compute nodes"
     
#   - name: wait for compute nodes to boot
#     local_action: wait_for host={{ last_node }} state=started delay=30 timeout=600

   - name: set files to provision
     command: wwsh -y provision set {{ node_glob }} --files=passwd,group,shadow,munge.key,slurm.conf,dynamic_hosts,network

   - name: tell nodes to get files
     command: pdsh -w {{ node_glob }} /warewulf/bin/wwgetfiles

   - name: start munge
     service: name=munge state=restarted

   - name: start slurmctld
     service: name=slurmctld state=restarted

   - name: start munge on compute nodes
     shell: pdsh -w "{{ node_glob }}" systemctl start munge

   - name: start slurmd on compute nodes
     shell: pdsh -w "{{ node_glob }}" systemctl start slurmd

   - name: update slurm status on nodes
     command: scontrol update nodename={{ node_glob }} state=idle

   vars_prompt:
    - name: "private_interface"
      prompt: "Enter the private network interface (default is enp0s8):"
      private: no
      default: "enp0s8"
    - name: "num_nodes"
      prompt: "How many compute nodes do you have?"
      private: no
      default: 0
    - name: "node_prefix"
      prompt: "How do you want to prefix your compute nodes?"
      private: no
      default: compute

   vars:
    - node_glob: "{{ node_prefix }}[0-{{ num_nodes|int - 1}}]"
    - node_glob_bash: "{{ node_prefix }}{0..{{ num_nodes|int - 1}}}"
    - last_node: "{{ node_prefix }}{{ num_nodes|int - 1 }}"
